<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerador de Chaveiro STL</title>
<style>
body {
  margin: 0;
  display: flex;
  height: 100vh;
  font-family: Arial, sans-serif;
}
#ui {
  width: 320px;
  padding: 12px;
  background: #1e1e1e;
  color: #fff;
  overflow-y: auto;
}
#ui input, #ui select, #ui button {
  width: 100%;
  margin-bottom: 8px;
}
#viewer {
  flex: 1;
}
label {
  font-size: 13px;
}
button {
  padding: 8px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="ui">
  <h3>ðŸ”‘ Gerador de Chaveiro STL</h3>

  <label>Texto</label>
  <input id="text" value="BRYAM">

  <label>Fonte</label>
  <select id="font">
    <option value="https://cdn.jsdelivr.net/npm/opentype.js@latest/examples/fonts/Roboto-Black.ttf">Roboto Black</option>
    <option value="https://cdn.jsdelivr.net/npm/opentype.js@latest/examples/fonts/Roboto-Regular.ttf">Roboto Regular</option>
    <option value="https://cdn.jsdelivr.net/npm/opentype.js@latest/examples/fonts/Roboto-Bold.ttf">Roboto Bold</option>
  </select>

  <label>Tamanho da fonte</label>
  <input type="number" id="fontSize" value="40">

  <label>Altura das letras (mm)</label>
  <input type="number" id="textHeight" value="4">

  <label>Espessura do fundo (mm)</label>
  <input type="number" id="baseHeight" value="3">

  <label>Margem do fundo</label>
  <input type="number" id="padding" value="5">

  <label>DiÃ¢metro do furo (mm)</label>
  <input type="number" id="holeSize" value="6">

  <label>Separar letras do fundo</label>
  <select id="separate">
    <option value="false">NÃ£o</option>
    <option value="true">Sim</option>
  </select>

  <button onclick="generate()">ðŸ”„ Atualizar Preview</button>
  <button onclick="exportSTL()">ðŸ’¾ Exportar STL</button>
</div>

<div id="viewer"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/exporters/STLExporter.js"></script>
<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three-csgmesh@1/build/three-csgmesh.umd.js"></script>

<script>
let scene, camera, renderer, controls;
let currentMesh;

init();
generate();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222222);

  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, -80, 60);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth - 320, window.innerHeight);
  document.getElementById("viewer").appendChild(renderer.domElement);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(50, 50, 100);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0xffffff, 0.4));

  animate();
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

async function generate() {
  if (currentMesh) scene.remove(currentMesh);

  const text = document.getElementById("text").value;
  const fontUrl = document.getElementById("font").value;
  const fontSize = +document.getElementById("fontSize").value;
  const textHeight = +document.getElementById("textHeight").value;
  const baseHeight = +document.getElementById("baseHeight").value;
  const padding = +document.getElementById("padding").value;
  const holeSize = +document.getElementById("holeSize").value;
  const separate = document.getElementById("separate").value === "true";

  const font = await opentype.load(fontUrl);
  const path = font.getPath(text, 0, 0, fontSize);
  const shapes = opentypePathToShapes(path);

  const textGeo = new THREE.ExtrudeGeometry(shapes, {
    depth: textHeight,
    bevelEnabled: false
  });

  textGeo.center();
  const textMesh = new THREE.Mesh(textGeo, new THREE.MeshStandardMaterial({ color: 0xffffff }));

  const box = new THREE.Box3().setFromObject(textMesh);
  const size = box.getSize(new THREE.Vector3());

  const baseGeo = new THREE.BoxGeometry(
    size.x + padding * 2,
    size.y + padding * 2,
    baseHeight
  );

  const baseMesh = new THREE.Mesh(baseGeo, new THREE.MeshStandardMaterial({ color: 0x4444ff }));
  baseMesh.position.z = -baseHeight / 2;

  const holeGeo = new THREE.CylinderGeometry(holeSize / 2, holeSize / 2, baseHeight + 10, 32);
  holeGeo.rotateX(Math.PI / 2);
  const holeMesh = new THREE.Mesh(holeGeo);
  holeMesh.position.y = size.y / 2 + padding / 2;

  let baseCSG = CSG.fromMesh(baseMesh);
  baseCSG = baseCSG.subtract(CSG.fromMesh(holeMesh));
  const finalBase = CSG.toMesh(baseCSG, baseMesh.matrix, baseMesh.material);

  if (!separate) {
    const union = CSG.fromMesh(finalBase).union(CSG.fromMesh(textMesh));
    currentMesh = CSG.toMesh(union, finalBase.matrix, finalBase.material);
  } else {
    currentMesh = new THREE.Group();
    currentMesh.add(finalBase);
    currentMesh.add(textMesh);
  }

  scene.add(currentMesh);
}

function exportSTL() {
  const exporter = new THREE.STLExporter();
  const data = exporter.parse(currentMesh);
  const blob = new Blob([data], { type: "application/octet-stream" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chaveiro.stl";
  a.click();
}

function opentypePathToShapes(path) {
  const shapes = [];
  let shape = new THREE.Shape();

  path.commands.forEach(cmd => {
    if (cmd.type === "M") shape.moveTo(cmd.x, cmd.y);
    else if (cmd.type === "L") shape.lineTo(cmd.x, cmd.y);
    else if (cmd.type === "C") shape.bezierCurveTo(cmd.x1, cmd.y1, cmd.x2, cmd.y2, cmd.x, cmd.y);
    else if (cmd.type === "Z") {
      shapes.push(shape);
      shape = new THREE.Shape();
    }
  });

  return shapes;
}
</script>

</body>
</html>
