<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerador de Chaveiro STL</title>
<style>
body {
  margin: 0;
  display: flex;
  height: 100vh;
  font-family: Arial, sans-serif;
}
#ui {
  width: 320px;
  padding: 12px;
  background: #1e1e1e;
  color: #fff;
  overflow-y: auto;
}
#ui input, #ui select, #ui button {
  width: 100%;
  margin-bottom: 8px;
}
#viewer {
  flex: 1;
}
#log {
  background: #000;
  color: #0f0;
  font-size: 12px;
  padding: 6px;
  height: 120px;
  overflow-y: auto;
}
button {
  padding: 8px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="ui">
  <h3>üîë Gerador de Chaveiro STL</h3>

  <label>Texto</label>
  <input id="text" value="BRYAM">

  <label>Fonte</label>
  <select id="font">
  <option value="https://raw.githubusercontent.com/google/fonts/main/apache/roboto/Roboto-Bold.ttf">

      Roboto Bold
    </option>
  </select>

  <label>Tamanho da fonte</label>
  <input type="number" id="fontSize" value="40">

  <label>Altura letras (mm)</label>
  <input type="number" id="textHeight" value="4">

  <label>Espessura base (mm)</label>
  <input type="number" id="baseHeight" value="3">

  <label>Margem base</label>
  <input type="number" id="padding" value="6">

  <button onclick="generate()">üîÑ Atualizar Preview</button>
  <button onclick="exportSTL()">üíæ Exportar STL</button>

  <h4>üìú Log</h4>
  <div id="log"></div>
</div>

<div id="viewer"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/exporters/STLExporter.js"></script>
<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>

<script>
let scene, camera, renderer, controls;
let currentGroup;

function log(msg) {
  const el = document.getElementById("log");
  el.innerHTML += msg + "<br>";
  el.scrollTop = el.scrollHeight;
}

init();
generate();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222222);

  camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
  camera.position.set(0, -80, 60);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  document.getElementById("viewer").appendChild(renderer.domElement);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(50, 50, 100);
  scene.add(light);

  window.addEventListener("resize", resize);
  resize();
  animate();

  log("‚úî Scene inicializada");
}

function resize() {
  const w = window.innerWidth - 320;
  const h = window.innerHeight;
  renderer.setSize(w, h);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

async function generate() {
  try {
    log("‚è≥ Gerando modelo...");

    if (currentGroup) scene.remove(currentGroup);
    currentGroup = new THREE.Group();

    const text = document.getElementById("text").value;
    const fontUrl = document.getElementById("font").value;
    const fontSize = +document.getElementById("fontSize").value;
    const textHeight = +document.getElementById("textHeight").value;
    const baseHeight = +document.getElementById("baseHeight").value;
    const padding = +document.getElementById("padding").value;

    log("üî§ Carregando fonte...");
    const font = await opentype.load(fontUrl);

    const path = font.getPath(text, 0, 0, fontSize);
    const shapes = opentypePathToShapes(path);

    if (!shapes.length) {
      log("‚ùå Nenhum shape gerado");
      return;
    }

    log("‚úî Shapes gerados: " + shapes.length);

    const textGeo = new THREE.ExtrudeGeometry(shapes, {
      depth: textHeight,
      bevelEnabled: false
    });

    textGeo.center();

    const textMesh = new THREE.Mesh(
      textGeo,
      new THREE.MeshStandardMaterial({ color: 0xffffff })
    );

    const box = new THREE.Box3().setFromObject(textMesh);
    const size = box.getSize(new THREE.Vector3());

    const baseGeo = new THREE.BoxGeometry(
      size.x + padding * 2,
      size.y + padding * 2,
      baseHeight
    );

    const baseMesh = new THREE.Mesh(
      baseGeo,
      new THREE.MeshStandardMaterial({ color: 0x3366ff })
    );

    baseMesh.position.z = -baseHeight / 2;

    currentGroup.add(baseMesh);
    currentGroup.add(textMesh);

    scene.add(currentGroup);
    log("‚úÖ Preview atualizado");
  } catch (e) {
    log("‚ùå Erro: " + e.message);
  }
}

function opentypePathToShapes(path) {
  const shapes = [];
  let shape = new THREE.Shape();

  for (const cmd of path.commands) {
    if (cmd.type === "M") shape.moveTo(cmd.x, cmd.y);
    else if (cmd.type === "L") shape.lineTo(cmd.x, cmd.y);
    else if (cmd.type === "C")
      shape.bezierCurveTo(cmd.x1, cmd.y1, cmd.x2, cmd.y2, cmd.x, cmd.y);
    else if (cmd.type === "Z") {
      shapes.push(shape);
      shape = new THREE.Shape();
    }
  }

  return shapes;
}

function exportSTL() {
  if (!currentGroup) return;
  const exporter = new THREE.STLExporter();
  const data = exporter.parse(currentGroup);
  const blob = new Blob([data], { type: "application/octet-stream" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chaveiro.stl";
  a.click();
}
</script>

</body>
</html>
