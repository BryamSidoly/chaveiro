<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerador de Chaveiro STL</title>
<style>
body {
  margin: 0;
  display: flex;
  height: 100vh;
  font-family: Arial, sans-serif;
}
#ui {
  width: 320px;
  padding: 12px;
  background: #1e1e1e;
  color: #fff;
}
#ui input, #ui select, #ui button {
  width: 100%;
  margin-bottom: 8px;
}
#viewer {
  flex: 1;
}
button {
  padding: 8px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="ui">
  <h3>ðŸ”‘ Gerador de Chaveiro STL</h3>

  <label>Texto</label>
  <input id="text" value="BRYAM">

  <label>Fonte</label>
  <select id="font">
    <option value="https://cdn.jsdelivr.net/npm/opentype.js@latest/examples/fonts/Roboto-Bold.ttf">
      Roboto Bold
    </option>
  </select>

  <label>Tamanho da fonte</label>
  <input type="number" id="fontSize" value="40">

  <label>Altura letras (mm)</label>
  <input type="number" id="textHeight" value="4">

  <label>Espessura base (mm)</label>
  <input type="number" id="baseHeight" value="3">

  <label>Margem base</label>
  <input type="number" id="padding" value="6">

  <label>DiÃ¢metro do furo</label>
  <input type="number" id="holeSize" value="6">

  <button onclick="generate()">ðŸ”„ Atualizar</button>
  <button onclick="exportSTL()">ðŸ’¾ Exportar STL</button>
</div>

<div id="viewer"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/exporters/STLExporter.js"></script>
<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>

<script>
let scene, camera, renderer, controls;
let currentGroup;

init();
generate();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222222);

  camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
  camera.position.set(0, -80, 60);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  document.getElementById("viewer").appendChild(renderer.domElement);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(50, 50, 100);
  scene.add(light);

  window.addEventListener("resize", resize);
  resize();
  animate();
}

function resize() {
  const w = window.innerWidth - 320;
  const h = window.innerHeight;
  renderer.setSize(w, h);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

async function generate() {
  if (currentGroup) scene.remove(currentGroup);
  currentGroup = new THREE.Group();

  const text = textInput();
  const font = await opentype.load(fontSelect());
  const fontSize = +val("fontSize");
  const textHeight = +val("textHeight");
  const baseHeight = +val("baseHeight");
  const padding = +val("padding");
  const holeSize = +val("holeSize");

  const shapes = font.getPaths(text, 0, 0, fontSize)
    .flatMap(p => p.toShapes(true));

  const textGeo = new THREE.ExtrudeGeometry(shapes, {
    depth: textHeight,
    bevelEnabled: false
  });

  textGeo.center();
  const textMesh = new THREE.Mesh(
    textGeo,
    new THREE.MeshStandardMaterial({ color: 0xffffff })
  );

  const box = new THREE.Box3().setFromObject(textMesh);
  const size = box.getSize(new THREE.Vector3());

  const baseGeo = new THREE.BoxGeometry(
    size.x + padding * 2,
    size.y + padding * 2,
    baseHeight
  );

  const baseMesh = new THREE.Mesh(
    baseGeo,
    new THREE.MeshStandardMaterial({ color: 0x3366ff })
  );

  baseMesh.position.z = -baseHeight / 2;

  const holeGeo = new THREE.CylinderGeometry(
    holeSize / 2,
    holeSize / 2,
    baseHeight + 1,
    32
  );
  holeGeo.rotateX(Math.PI / 2);

  const holeMesh = new THREE.Mesh(holeGeo);
  holeMesh.position.y = size.y / 2 + padding / 2;

  baseMesh.updateMatrix();
  holeMesh.updateMatrix();

  const baseCSG = THREE.CSG.fromMesh(baseMesh)
    .subtract(THREE.CSG.fromMesh(holeMesh));

  const finalBase = THREE.CSG.toMesh(
    baseCSG,
    baseMesh.matrix,
    baseMesh.material
  );

  currentGroup.add(finalBase);
  currentGroup.add(textMesh);

  scene.add(currentGroup);
}

function exportSTL() {
  const exporter = new THREE.STLExporter();
  const data = exporter.parse(currentGroup);
  const blob = new Blob([data], { type: "application/octet-stream" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chaveiro.stl";
  a.click();
}

function val(id) {
  return document.getElementById(id).value;
}
function textInput() {
  return document.getElementById("text").value;
}
function fontSelect() {
  return document.getElementById("font").value;
}
</script>

</body>
</html>
